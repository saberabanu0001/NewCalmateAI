{% extends 'base.html' %}
{% block title %}Emergency Contacts - CalmMateAI{% endblock %}
{% block head %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
            <div class="bg-white rounded-lg shadow-lg p-8">
                <div class="text-center mb-8">
                    <h1 class="text-4xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-phone-alt text-red-500 mr-3"></i>
                        Emergency Contacts
                    </h1>
                    <p class="text-gray-600 text-lg">Find emergency contacts and crisis hotlines in your area. Help is available 24/7.</p>
                </div>
                
                <!-- Global Crisis Hotlines -->
                <div class="bg-gradient-to-r from-red-50 to-pink-50 border border-red-200 rounded-xl p-6 mb-8">
                    <h2 class="text-2xl font-semibold text-red-800 mb-6 flex items-center">
                        <i class="fas fa-exclamation-triangle mr-3"></i>
                        Global Crisis Hotlines
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="bg-white rounded-lg p-4 shadow-sm border border-red-100 hover:shadow-md transition-shadow">
                            <div class="flex items-center mb-3">
                                <i class="fas fa-phone text-red-600 mr-3 text-xl"></i>
                                <div>
                                    <p class="font-semibold text-gray-800">Suicide Prevention</p>
                                    <p class="text-sm text-gray-600">24/7 Support</p>
                                </div>
                            </div>
                            <p class="text-gray-700 mb-3">988 (US) or 1-800-273-8255</p>
                            <a href="tel:988" class="inline-flex items-center px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors text-sm">
                                <i class="fas fa-phone mr-2"></i>
                                Call Now
                            </a>
                        </div>
                        
                        <div class="bg-white rounded-lg p-4 shadow-sm border border-red-100 hover:shadow-md transition-shadow">
                            <div class="flex items-center mb-3">
                                <i class="fas fa-sms text-red-600 mr-3 text-xl"></i>
                                <div>
                                    <p class="font-semibold text-gray-800">Crisis Text Line</p>
                                    <p class="text-sm text-gray-600">Text Support</p>
                                </div>
                            </div>
                            <p class="text-gray-700 mb-3">Text HOME to 741741</p>
                            <a href="sms:741741&body=HOME" class="inline-flex items-center px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors text-sm">
                                <i class="fas fa-sms mr-2"></i>
                                Text Now
                            </a>
                        </div>
                        
                        <div class="bg-white rounded-lg p-4 shadow-sm border border-red-100 hover:shadow-md transition-shadow">
                            <div class="flex items-center mb-3">
                                <i class="fas fa-ambulance text-red-600 mr-3 text-xl"></i>
                                <div>
                                    <p class="font-semibold text-gray-800">Emergency Services</p>
                                    <p class="text-sm text-gray-600">Police, Fire, Medical</p>
                                </div>
                            </div>
                            <p class="text-gray-700 mb-3">911 (US) or local emergency</p>
                            <a href="tel:911" class="inline-flex items-center px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors text-sm">
                                <i class="fas fa-phone mr-2"></i>
                                Call 911
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Location-based Contacts -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl p-6">
                    <h2 class="text-2xl font-semibold text-blue-800 mb-6 flex items-center">
                        <i class="fas fa-map-marker-alt mr-3"></i>
                        Find Local Resources
                    </h2>
                    <form id="location-form" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-globe mr-1"></i>
                                    Country
                                </label>
                                <input type="text" id="country" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" placeholder="e.g., United States, South Korea">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-city mr-1"></i>
                                    City
                                </label>
                                <input type="text" id="city" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" placeholder="e.g., New York, Seoul">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-list mr-1"></i>
                                    Category
                                </label>
                                <select id="category" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                                    <option value="helplines">Crisis Hotlines</option>
                                    <option value="doctors">Mental Health Professionals</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex justify-center">
                            <button type="submit" class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-8 py-3 rounded-lg hover:from-blue-700 hover:to-indigo-700 transition-all transform hover:scale-105 shadow-lg">
                                <i class="fas fa-search mr-2"></i>
                                Find Local Contacts
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Results will be displayed here -->
                <div id="results" class="mt-8 hidden">
                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-xl p-6">
                        <h3 class="text-2xl font-semibold text-green-800 mb-6 flex items-center">
                            <i class="fas fa-check-circle mr-3"></i>
                            Local Resources Found
                        </h3>
                        <div id="contacts-content" class="space-y-4"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
        // Auto-submit when category changes (if form already has results)
        let hasResults = false;
        
        document.getElementById('category').addEventListener('change', function() {
            const country = document.getElementById('country').value.trim();
            const city = document.getElementById('city').value.trim();
            
            // Only auto-submit if we have both country and city filled
            if (country && city) {
                document.getElementById('location-form').dispatchEvent(new Event('submit'));
            }
        });
        
        // Add loading state and better error handling
        document.getElementById('location-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                country: document.getElementById('country').value.trim(),
                city: document.getElementById('city').value.trim(),
                category: document.getElementById('category').value
            };

            // Show loading state
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Searching...';
            submitBtn.disabled = true;

            try {
                const response = await fetch('/api/contacts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                
                if (data.contacts_markdown && data.contacts_markdown !== `No information found for ${formData.city}, ${formData.country}.`) {
                    // Parse markdown and create better formatted display
                    const contactsHtml = parseContactsMarkdown(data.contacts_markdown);
                    document.getElementById('contacts-content').innerHTML = contactsHtml;
                    document.getElementById('results').classList.remove('hidden');
                    
                    // Scroll to results
                    document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
                } else {
                    document.getElementById('contacts-content').innerHTML = `
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-triangle text-yellow-600 mr-3"></i>
                                <div>
                                    <p class="font-semibold text-yellow-800">No contacts found</p>
                                    <p class="text-yellow-700">We couldn't find specific contacts for ${formData.city}, ${formData.country}. Please try a different location or use the global hotlines above.</p>
                                </div>
                            </div>
                        </div>
                    `;
                    document.getElementById('results').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error fetching contacts:', error);
                document.getElementById('contacts-content').innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="flex items-center">
                            <i class="fas fa-exclamation-circle text-red-600 mr-3"></i>
                            <div>
                                <p class="font-semibold text-red-800">Error loading contacts</p>
                                <p class="text-red-700">Please check your internet connection and try again.</p>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('results').classList.remove('hidden');
            } finally {
                // Reset button state
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // Function to parse markdown and create better formatted HTML
        function parseContactsMarkdown(markdown) {
            const lines = markdown.split('\n');
            let html = '';
            let currentContact = null;
            
            for (let line of lines) {
                line = line.trim();
                
                if (line.startsWith('###')) {
                    // Location header
                    const location = line.replace('###', '').trim();
                    html += `<h4 class="text-lg font-semibold text-gray-800 mb-4">${location}</h4>`;
                } else if (line.startsWith('**') && line.endsWith('**')) {
                    // Contact name
                    if (currentContact) {
                        html += formatContactCard(currentContact);
                    }
                    currentContact = {
                        name: line.replace(/\*\*/g, ''),
                        number: '',
                        url: ''
                    };
                } else if (line.startsWith('- Phone:')) {
                    // Phone number
                    if (currentContact) {
                        currentContact.number = line.replace('- Phone: `', '').replace('`', '');
                    }
                } else if (line.startsWith('- Website:')) {
                    // Website URL
                    if (currentContact) {
                        currentContact.url = line.replace('- Website: <', '').replace('>', '');
                    }
                }
            }
            
            // Add the last contact
            if (currentContact) {
                html += formatContactCard(currentContact);
            }
            
            return html || '<p class="text-gray-600">No contact information available.</p>';
        }

        // Function to format individual contact cards
        function formatContactCard(contact) {
            return `
                <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200 hover:shadow-md transition-shadow">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h5 class="font-semibold text-gray-800 mb-2">${contact.name}</h5>
                            ${contact.number ? `
                                <div class="flex items-center mb-2">
                                    <i class="fas fa-phone text-green-600 mr-2"></i>
                                    <span class="text-gray-700">${contact.number}</span>
                                </div>
                            ` : ''}
                            ${contact.url ? `
                                <div class="flex items-center">
                                    <i class="fas fa-globe text-blue-600 mr-2"></i>
                                    <a href="${contact.url}" target="_blank" rel="noopener" class="text-blue-600 hover:text-blue-800 underline">Visit Website</a>
                                </div>
                            ` : ''}
                        </div>
                        ${contact.number ? `
                            <a href="tel:${contact.number.replace(/[^\d+]/g, '')}" class="ml-4 bg-green-500 text-white px-3 py-2 rounded-lg hover:bg-green-600 transition-colors">
                                <i class="fas fa-phone mr-1"></i>
                                Call
                            </a>
                        ` : ''}
                    </div>
                </div>
            `;
        }
    </script>
{% endblock %} 